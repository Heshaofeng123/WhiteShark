<!-- 
      information_details.html
      Nieplus，资讯详情页
      
      Created by 华地文化 on 2016-12-19.
      Copyright 2016 华地文化. All rights reserved.
 -->

<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" type="text/css" href="css/mui.min.css" />
		<link rel="stylesheet" href="css/inof.css" />
	</head>

	<body contextmenu="return false;">
		<header class="mui-bar mui-bar-nav" style="background: white;">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">资讯详情</h1>
		</header>
		<div class="mui-content">
			<div class="mui-content-padded">
				<div class="Article">
					<iframe src="http://192.168.0.112/fuwu/file/201612/20/1.html" id="iframepage" name="iframepage" frameBorder=0 scrolling=no width="100%" onLoad="reinitIframeEND();"></iframe>
				</div>
			</div>
			<div class="ass_tit">
				<span>关联新闻</span>
			</div>
			<div class="Associated">
				<ul id="list" class="mui-table-view mui-table-view-chevron" style="background: #efeff4;">
				</ul>
			</div>
		</div>
		<footer>
			<div class="operation">
				<div class="oper_one">
					<div class="oper_xie">
						<span id="xie">写评论...</span>
						<div class="oper_two" id="shuru" style="display: none;">
							<textarea id="contentId" placeholder="写评论"></textarea>
							<button type="submit">提交</button>
						</div>
					</div>
					<div class="oper_du">
						<a href="#">
							<em id="comment_list"></em>
							<span>324</span>
						</a>
					</div>
					<div class="oper_zan">
						<em id="like"></em>
						<span>324</span>
					</div>
				</div>
			</div>
		</footer>
	</body>
	<script src="js/mui.min.js"></script>
	<script type="text/javascript" src="libs/jquery-1.8.3.min.js"></script>
	<script src="js/mui.zoom.js"></script>
	<script src="js/mui.previewimage.js"></script>
	<script src="js/common.js"></script>
	<!--<script src="js/info.js"></script>-->
	<script>
		$("#shuru").hide();
		$("#xie").click(
			function() {
				$("#shuru").show();
			}
		);

		$("#shuru button").click(function() {
			var content = document.getElementById("contentId").value;
			sendComment(1, 1, content);
			$("#shuru").hide();
		});

		function reinitIframe() {
			var iframe = document.getElementById("iframepage");
			try {
				var bHeight = iframe.contentWindow.document.body.scrollHeight;
				var dHeight = iframe.contentWindow.document.documentElement.scrollHeight;
				var height = Math.max(bHeight, dHeight);
				iframe.height = height;
			} catch(ex) {}
		}

		var timer1 = window.setInterval("reinitIframe()", 500); //定时开始  

		function reinitIframeEND() {
			var iframe = document.getElementById("iframepage");
			try {
				var bHeight = iframe.contentWindow.document.body.scrollHeight;
				var dHeight = iframe.contentWindow.document.documentElement.scrollHeight;
				var height = Math.max(bHeight, dHeight);
				iframe.height = height;
			} catch(ex) {}
			// 停止定时  
			window.clearInterval(timer1);
		}

		mui.init();

		function getCookie(c_name) {
			if(document.cookie.length > 0) {
				c_start = document.cookie.indexOf(c_name + "=")
				if(c_start != -1) {
					c_start = c_start + c_name.length + 1
					c_end = document.cookie.indexOf(";", c_start)
					if(c_end == -1) c_end = document.cookie.length
					return unescape(document.cookie.substring(c_start, c_end))
				}
			}
			return ""
		}

		//		function setCookie(c_name, value, expiredays) {
		//			var exdate = new Date()
		//			exdate.setDate(exdate.getDate() + expiredays)
		//			document.cookie = c_name + "=" + escape(value) +
		//				((expiredays == null) ? "" : "; expires=" + exdate.toGMTString())
		//		}
		//		setCookie('name', '123');
		self = plus.webview.currentWebview();
		var articleId = self.articleId;
		var articleUrl = self.articleUrl;
		var articleLike = self.articleLike;
		console.log('文章id：：：' + articleId + '文章url：：：' + articleUrl + '文章like：：：：' + articleLike);

		/**
		 * 	推荐列表跳转
		 */
		mui('#list').on('tap', 'a', function() {
			var id = this.getAttribute('href');
			var href = this.href;
			var articleid = document.getElementById("articleid").value;
			var cook = getCookie('name');
			mui.openWindow({
				id: id,
				url: this.href,
				styles: {
					popGesture: 'close',
				},
				extras: {
					articleId: articleid,
					articleUrl: 'adsfasdfasdfasdfasdf',
					articleLike: cook,
				}
			});
		});

		$("#like").click(
			function() {
				sendLike(1);
			}
		);
		$("#comment_list").click(function() {
			mui.openWindow({
				url: 'comment.html',
				styles: {
					popGesture: 'close',
				}
			});
		});

		/**
		 * 	ajax请求控制台日志，手机debug可查看控制台日志。
		 */
		$.ajax({
			beforeSend: function(xhr, setting) {
				console.log('beforeSend:::' + JSON.stringify(setting));
			}
		});
		$.ajax({
			complete: function(xhr, status) {
				console.log('complete:::' + status);
			}
		});

		/**
		 * 获取推荐资讯列表请求
		 * @param {Object} articleId  文章id
		 */
		var getInformationList = function(articleId) {
			var waiting = Common.showWaiting();
			mui.ajax('http://192.168.0.112/fuwu/api/article.php', {
				data: {
					action: 'check',
					id: 1
				},
				dataType: 'json', //服务器返回html格式数据
				type: 'post', //HTTP请求类型
				timeout: 10000, //超时时间设置为10秒；
				success: function(data) {
					Common.closeWaiting(waiting);
					var result = JSON.stringify(data);
					console.log('result：：：：' + result);
					var table = document.body.querySelector('.mui-table-view');
					for(var i = 0; i < data.result.list.length; i++) {
						var li = document.createElement('li');
						li.innerHTML = '<input type="hidden" value="2" id="articleid"/><a id="" href="information_details.html"><h3>' + (data.result.list[i].arr[0]) + '</h3><p>华地艺术网专稿</p></a>';
						table.appendChild(li);
					}
				},
				error: function(xhr, type, errorThrown) {
					Common.closeWaiting(waiting);
					console.log('获取推荐资讯列表请求 失败!!!');
				}
			});
		};
		getInformationList();

		/**
		 * 发送评论请求
		 * @param {Object} articleId
		 */
		var sendComment = function(userId, articleId, commentContent) {
			var waiting = Common.showWaiting();
			mui.ajax('http://192.168.0.112/fuwu/api/addValue.php', {
				data: {
					action: 'comment',
					userid: userId,
					articleid: articleId,
					content: commentContent
				},
				dataType: 'json', //服务器返回json格式数据
				type: 'post', //HTTP请求类型
				timeout: 10000, //超时时间设置为10秒；
				success: function(data) {
					Common.closeWaiting(waiting);
					alert('评论已成功...')
				},
				error: function(xhr, type, errorThrown) {
					Common.closeWaiting(waiting);
					console.log('发送评论请求 失败!!!');
				}
			});
		};

		/**
		 * 发送点赞请求
		 * @param {Object} userId 用户id
		 * @param {Object} articleId 文章id
		 */
		var sendLike = function(articleId) {
			var waiting = Common.showWaiting();
			mui.ajax('http://192.168.0.112/fuwu/api/addValue.php', {
				data: {
					action: 'like',
					id: articleId
				},
				dataType: 'json', //服务器返回json格式数据
				type: 'post', //HTTP请求类型
				timeout: 10000, //超时时间设置为10秒；
				success: function(data) {
					Common.closeWaiting(waiting);
					alert('点赞已成功...');
				},
				error: function(xhr, type, errorThrown) {
					Common.closeWaiting(waiting);
					console.log('发送点赞请求 失败!!!');
				}
			});
		};
	</script>

</html>