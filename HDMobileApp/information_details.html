
<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" type="text/css" href="css/mui.min.css" />
		<link rel="stylesheet" href="css/inof.css" />
	</head>

	<body contextmenu="return false;">
		<header class="mui-bar mui-bar-nav" style="background: white;">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">资讯详情</h1>
		</header>
		<div class="mui-content">
			<div class="mui-content-padded">
				<div class="Article" id="article_details">
					<!--<iframe src="" id="iframepage" name="iframepage" frameBorder=0 scrolling=no width="100%" onLoad="reinitIframeEND();"></iframe>-->
				</div>
			</div>
			<div class="ass_tit">
				<span>关联新闻</span>
			</div>
			<div class="Associated">
				<ul id="list" class="mui-table-view mui-table-view-chevron" style="background: #efeff4;">
				</ul>
			</div>
		</div>
		<footer>
			<div class="operation">
				<div class="oper_one">
					<div class="oper_xie">
						<span id="xie">写评论...</span>
					</div>
					<div class="oper_du">
						<a href="#">
							<em id="comment_list"></em>
							<span id="comment_num">0</span>
						</a>
					</div>
					<div class="oper_zan">
						<em id="like"></em>
						<span id="like_num">0</span>
					</div>
				</div>
				<div class="oper_two" id="shuru" style="display: none;">
					<!--<form>-->
						<textarea id="contentId" placeholder="写评论"></textarea>
						<button type="submit">提交</button>
					<!--</form>-->
				</div>
			</div>
		</footer>
	</body>
	<script src="js/mui.min.js"></script>
	<script type="text/javascript" src="libs/jquery-1.8.3.min.js"></script>
	<script src="js/mui.zoom.js"></script>
	<script src="js/mui.previewimage.js"></script>
	<script src="js/common.js"></script>
	<!--<script src="js/info.js"></script>-->
	
	<script>
		 function stopPropagation(e) {  
	        if (e.stopPropagation)  
	            e.stopPropagation();  
	        else  
	            e.cancelBubble = true;  
	    }  
	  
	    $(document).bind('click', function() {  
	        $('#shuru').css('display', 'none');  
	    });  
	  
	    $('#xie').bind('click', function(e) {  
	        stopPropagation(e); 
	        $("#shuru").show();
	    });  
	    $('#shuru').bind('click', function(e) {  
	        stopPropagation(e); 
	        $("this").show();
	    }); 
	    
	    $("#shuru").hide();
		$("#xie").click(
			function() {
				$("#shuru").show();
			}
		);
		//		$("#shuru button").click(function() {
		//			var content = document.getElementById("contentId").value;
		//			sendComment(1, 1, content);
		//			$("#shuru").hide();
		//		});
		mui('#shuru').on('tap', 'button', function() {
			var content = document.getElementById("contentId").value;
			sendComment(1, 1, content);
			$("#shuru").hide();
		});
	    
	    

		function reinitIframe() {
			var iframe = document.getElementById("iframepage");
			try {
				var bHeight = iframe.contentWindow.document.body.scrollHeight;
				var dHeight = iframe.contentWindow.document.documentElement.scrollHeight;
				var height = Math.max(bHeight, dHeight);
				iframe.height = height;
			} catch(ex) {}
		}

		var timer1 = window.setInterval("reinitIframe()", 500); //定时开始  

		function reinitIframeEND() {
			var iframe = document.getElementById("iframepage");
			try {
				var bHeight = iframe.contentWindow.document.body.scrollHeight;
				var dHeight = iframe.contentWindow.document.documentElement.scrollHeight;
				var height = Math.max(bHeight, dHeight);
				iframe.height = height;
			} catch(ex) {}
			// 停止定时  
			window.clearInterval(timer1);
		}

		mui.init();
		var articleId;
		var articleUrl;
		var articleLike;
		mui.plusReady(function() {
			self = plus.webview.currentWebview();
			$("#like_num").text(self.likes);
			articleId = self.articleid;
			articleUrl = self.articleurl;
			articleLike = self.likes;
			var article_details = document.getElementById("article_details");
			article_details.innerHTML = '<iframe src=' + (articleUrl) + ' id="iframepage" name="iframepage" frameBorder=0 scrolling=no width="100%" onLoad="reinitIframeEND();"></iframe>';
			console.log('文章id：：：' + articleId + '文章url：：：' + articleUrl + '文章like：：：：' + articleLike);
		});

		/**
		 * 	推荐列表跳转
		 */
		mui('#list').on('tap', 'a', function() {
			var id = this.getAttribute('href');
			var href = this.href;
			var articleid = this.getAttribute('id');
			var likes = this.getAttribute('likes');
			var articleurl = this.getAttribute('deburl');
			mui.openWindow({
				id: articleid,
				url: href,
				styles: {
					popGesture: 'close',
				},
				extras: {
					articleid: articleid,
					articleurl: articleurl,
					likes: likes
				}
			});
		});

		$("#like").click(
			function() {
				sendLike(1);
			}
		);
		$("#comment_list").click(function() {
			mui.openWindow({
				url: 'comment.html',
				styles: {
					popGesture: 'close',
				}
			});
		});

		/**
		 * 	ajax请求控制台日志，手机debug可查看控制台日志。
		 */
		$.ajax({
			beforeSend: function(xhr, setting) {
				console.log('beforeSend:::' + JSON.stringify(setting));
			}
		});
		$.ajax({
			complete: function(xhr, status) {
				console.log('complete:::' + status);
			}
		});

		/**
		 * 获取推荐资讯列表请求
		 * @param {Object} articleId  文章id
		 */
		var getInformationList = function(articleId) {
			var waiting = Common.showWaiting();
			mui.ajax(Common.domain+'/fuwu/api/article.php', {
				data: {
					action: 'check',
					id: 1
				},
				dataType: 'json', //服务器返回html格式数据
				type: 'post', //HTTP请求类型
				timeout: 10000, //超时时间设置为10秒；
				success: function(data) {
					Common.closeWaiting(waiting);
					var result = JSON.stringify(data);
					console.log('result：：：：' + result);
					$("#comment_num").text(data.result.commentnum);
					var table = document.body.querySelector('.mui-table-view');
					for(var i = 0; i < data.result.list.length; i++) {
						var li = document.createElement('li');
						li.innerHTML = '<a id="" href="information_details.html" id="' + (data.result.list[i].id) + '" deburl="' + (data.result.list[i].deburl) + '" likes="' + (data.result.list[i].likes) + '"><h3>' + (data.result.list[i].arr[0]) + '</h3><p>华地艺术网专稿</p></a>';
						table.appendChild(li);
					}
				},
				error: function(xhr, type, errorThrown) {
					Common.closeWaiting(waiting);
					console.log('获取推荐资讯列表请求 失败!!!');
				}
			});
		};
		getInformationList();

		/**
		 * 发送评论请求
		 * @param {Object} articleId
		 */
		var sendComment = function(userId, articleId, commentContent) {
			var waiting = Common.showWaiting();
			mui.ajax(Common.domain+'/fuwu/api/addValue.php', {
				data: {
					action: 'comment',
					userid: userId,
					articleid: articleId,
					content: commentContent
				},
				dataType: 'json', //服务器返回json格式数据
				type: 'post', //HTTP请求类型
				timeout: 10000, //超时时间设置为10秒；
				success: function(data) {
					Common.closeWaiting(waiting);
					mui.toast('评论已成功...');
//					alert('评论已成功...')
				},
				error: function(xhr, type, errorThrown) {
					Common.closeWaiting(waiting);
					console.log('发送评论请求 失败!!!');
				}
			});
		};

		/**
		 * 发送点赞请求
		 * @param {Object} userId 用户id
		 * @param {Object} articleId 文章id
		 */
		var sendLike = function(articleId) {
			var waiting = Common.showWaiting();
			mui.ajax(Common.domain+'/fuwu/api/addValue.php', {
				data: {
					action: 'like',
					id: articleId
				},
				dataType: 'json', //服务器返回json格式数据
				type: 'post', //HTTP请求类型
				timeout: 10000, //超时时间设置为10秒；
				success: function(data) {
					Common.closeWaiting(waiting);
					mui.toast('点赞已成功...',{ duration:'short', type:'div' }) ;
				},
				error: function(xhr, type, errorThrown) {
					Common.closeWaiting(waiting);
					console.log('发送点赞请求 失败!!!');
				}
			});
		};
	</script>

</html>